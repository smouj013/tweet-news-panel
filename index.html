<!-- index.html ‚Äî TNP v4.2.0 (COMPAT app.js v4.2.0 AUTH+MEMBERSHIP) ‚Äî FIXED HIDDEN + SW BOOT REPAIR + CONFIG BOOT + KOFI
  ‚úÖ 100% compatible con app.js v4.2.0 (IDs + modal feeds + ticker + X mock + botones)
  ‚úÖ FIX CLAVE: evita ‚Äúdoble ocultaci√≥n‚Äù (hidden attr + .hidden) que romp√≠a modales/gates si app.js solo quitaba una de las dos
  ‚úÖ AUTH: Login Google (GIS) + Gate opcional (si requireLogin=true)
  ‚úÖ MEMBERSHIP: FREE / PRO / ELITE (modal ‚ÄúPlanes‚Äù listo)
  ‚úÖ Cache-bust controlado (BUILD_TAG) para evitar ‚Äúapp.js viejo‚Äù en GitHub Pages
  ‚úÖ SW register con updateViaCache:"none" + update() peri√≥dico + Repair (purge caches + unregister SW)
  ‚úÖ Carga /config/boot-config.js ANTES de app.js
  ‚úÖ Bot√≥n Ko-fi en la topbar
-->
<!doctype html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#070A12" />
  <meta name="description" content="Panel PRO para extraer noticias (RSS/Atom), resolver links reales, im√°genes y generar plantilla lista para X. Incluye login y membres√≠as." />
  <meta name="referrer" content="strict-origin-when-cross-origin" />
  <meta name="robots" content="noindex,nofollow" />

  <!-- PWA -->
  <meta name="application-name" content="News ‚Üí Tweet Template Panel" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <!-- üîß Build tag √∫nico (√∫salo igual en scripts + SW abajo) -->
  <meta name="tnp-build" content="tnp-v4.2.0_2026-01-12d" />

  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" href="./assets/icons/favicon-32.png" sizes="32x32" />
  <link rel="icon" href="./assets/icons/icon-192.png" sizes="192x192" />
  <link rel="apple-touch-icon" href="./assets/icons/apple-touch-icon-180.png" sizes="180x180" />

  <!-- Proxies (anti-CORS) usados por app.js -->
  <link rel="preconnect" href="https://corsproxy.io" crossorigin />
  <link rel="preconnect" href="https://api.allorigins.win" crossorigin />
  <link rel="preconnect" href="https://api.codetabs.com" crossorigin />
  <link rel="preconnect" href="https://thingproxy.freeboard.io" crossorigin />
  <link rel="preconnect" href="https://r.jina.ai" crossorigin />
  <link rel="dns-prefetch" href="https://corsproxy.io" />
  <link rel="dns-prefetch" href="https://api.allorigins.win" />
  <link rel="dns-prefetch" href="https://api.codetabs.com" />
  <link rel="dns-prefetch" href="https://thingproxy.freeboard.io" />
  <link rel="dns-prefetch" href="https://r.jina.ai" />

  <!-- CSS -->
  <link rel="preload" href="./styles.css" as="style" />
  <link rel="stylesheet" href="./styles.css" />

  <title>News ‚Üí Tweet Template Panel</title>

  <!-- Google Identity Services (Login Google). app.js lo usa si auth.enabled=true -->
  <script async defer src="https://accounts.google.com/gsi/client"></script>

  <!-- üîß Fallback: asegura que .hidden SIEMPRE oculta (evita dependencias de styles.css) -->
  <style>
    .hidden{ display:none !important; }
  </style>

  <!-- Mini CSS local SOLO para banner de reparaci√≥n + gate + planes (no rompe tu styles.css) -->
  <style>
    .bootDiag{
      position: fixed;
      inset: auto calc(14px + env(safe-area-inset-right, 0px)) calc(14px + env(safe-area-inset-bottom, 0px)) calc(14px + env(safe-area-inset-left, 0px));
      z-index: 9999;
      display: grid;
      gap: 10px;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(8,12,20,0.92);
      box-shadow: 0 14px 50px rgba(0,0,0,0.55);
    }
    .bootDiag__row{ display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    .bootDiag__title{ font-weight: 900; }
    .bootDiag__msg{ color: rgba(231,233,234,0.70); font-size: 12px; line-height: 1.35; }
    .bootDiag .btn{ white-space: nowrap; }

    /* Gate (si requireLogin=true y hardGate=true) */
    .authGate{
      position: fixed;
      inset: 0;
      z-index: 9998;
      display: grid;
      place-items: center;
      padding: 18px;
      background: rgba(0,0,0,0.72);
    }
    .authGate__panel{
      width: min(820px, 96vw);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(8,12,20,0.92);
      box-shadow: 0 14px 50px rgba(0,0,0,0.55);
      padding: 16px;
    }
    .authGate__title{ font-weight: 900; font-size: 16px; margin-bottom: 6px; }
    .authGate__sub{ color: rgba(231,233,234,0.72); font-size: 12px; line-height: 1.35; margin-bottom: 12px; }

    /* Planes */
    .tierGrid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }
    @media (max-width: 860px){
      .tierGrid{ grid-template-columns: 1fr; }
    }
    .tierCard{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.05);
      padding: 12px;
      min-width: 0;
    }
    .tierCard__head{ display:flex; align-items:baseline; justify-content: space-between; gap: 10px; }
    .tierCard__name{ font-weight: 900; letter-spacing: .2px; }
    .tierCard__price{ color: rgba(231,233,234,0.70); font-size: 12px; }
    .tierCard__perks{ margin: 10px 0 12px; padding-left: 18px; color: rgba(231,233,234,0.80); font-size: 12px; line-height: 1.35; }
    .tierCard__perks li{ margin: 4px 0; }
    .tierCard__cta{ display:flex; gap: 10px; flex-wrap: wrap; }
  </style>
</head>

<body>
  <a class="skipLink" href="#main">Saltar a contenido</a>

  <!-- AUTH GATE (app.js lo mostrar√°/ocultar√°; por defecto oculto SOLO por .hidden) -->
  <div id="authGate" class="authGate hidden" aria-hidden="true">
    <div class="authGate__panel" role="dialog" aria-label="Acceso requerido">
      <div class="authGate__title">Inicia sesi√≥n para usar el panel</div>
      <div class="authGate__sub">
        Acceso con Google. Tu plan (FREE/PRO/ELITE) se aplica autom√°ticamente.
        <br/>Si est√°s en modo demo, el plan puede venir de <span style="font-family: ui-monospace, monospace;">localStorage tnp_membership_override</span>.
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <button id="btnLoginGate" class="btn btn--primary" type="button">Entrar con Google</button>
        <button id="btnOpenPlansGate" class="btn" type="button">Ver planes</button>
        <span id="authGateMsg" class="mini muted" style="margin-left:auto;"></span>
      </div>
    </div>
  </div>

  <!-- TOPBAR -->
  <header class="topbar" id="topbar">
    <div class="topbar__left">
      <div class="brand">
        <div class="brand__logo" aria-hidden="true">üõ∞Ô∏è</div>
        <div class="brand__txt">
          <div class="brand__title">News ‚Üí Tweet Panel</div>
          <div class="brand__sub">RSS directos ¬∑ Links reales ¬∑ Im√°genes ¬∑ Login ¬∑ Membres√≠a</div>
        </div>
      </div>

      <div class="topbar__controls">
        <label class="field field--inline">
          <span class="field__label">Buscar</span>
          <input id="searchBox" class="input input--sm" type="search" placeholder="Buscar titular / medio‚Ä¶" autocomplete="off" />
        </label>

        <button
          id="btnRefresh"
          class="btn btn--primary btn--sm"
          type="button"
          title="Refrescar (Shift+click = force + reset backoff)"
        >
          Refrescar
        </button>

        <button id="btnFeeds" class="btn btn--sm" type="button">Feeds</button>
        <button id="btnCheckUpdate" class="btn btn--sm" type="button">Update</button>
        <button id="btnHardReset" class="btn btn--danger btn--sm" type="button">Reset</button>

        <!-- ‚úÖ Planes / Membres√≠a -->
        <button id="btnPricing" class="btn btn--sm" type="button" title="Ver planes FREE/PRO/ELITE">üíé Planes</button>

        <!-- ‚úÖ Ko-fi -->
        <a
          id="btnKofi"
          class="btn btn--sm"
          href="https://ko-fi.com/global_eye"
          target="_blank"
          rel="noopener noreferrer"
          title="Apoya el proyecto en Ko-fi"
        >‚òï Ko-fi</a>
      </div>
    </div>

    <div class="topbar__right" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
      <!-- Membership/Auth box (app.js actualiza textos/visibilidad) -->
      <div id="authBox" class="row row--wrap" style="gap:8px;">
        <span id="tierBadge" class="badge" title="Plan actual">FREE</span>
        <span id="authUser" class="mini muted" title="Usuario">Sin sesi√≥n</span>
        <button id="btnLogin" class="btn btn--sm" type="button">Entrar</button>
        <button id="btnLogout" class="btn btn--sm" type="button" hidden>Salir</button>
        <button id="btnUpgrade" class="btn btn--primary btn--sm" type="button">Mejorar</button>
        <button id="btnManage" class="btn btn--sm" type="button" hidden>Gestionar</button>
      </div>

      <div id="status" class="status" role="status" aria-live="polite">Listo</div>
    </div>
  </header>

  <!-- TICKER -->
  <div class="ticker" id="ticker" aria-label="Ticker de noticias">
    <div class="ticker__label">√öLTIMA HORA</div>
    <div class="ticker__track">
      <div id="tnpTickerInner" class="ticker__inner">Cargando‚Ä¶</div>
    </div>
    <div id="tnpTrendsPop" class="ticker__pop" aria-hidden="true"></div>
  </div>

  <main id="main" class="layout">
    <div class="grid">
      <!-- LEFT: COMPOSER -->
      <section class="panel" aria-label="Compositor del tweet">
        <div class="panel__head">
          <div>
            <div class="panel__title">Plantilla</div>
            <div class="panel__sub">Click en una noticia ‚Üí se rellena y queda lista para copiar / abrir en X.</div>
          </div>
        </div>

        <div class="panel__body">
          <div class="grid2">
            <label class="field">
              <span class="field__label">üî¥ En vivo (tu link)</span>
              <input id="liveUrl" class="input" type="url" placeholder="https://twitch.tv/globaleyetv" inputmode="url" />
            </label>

            <label class="field">
              <span class="field__label">Hashtags</span>
              <input id="hashtags" class="input" type="text" placeholder="#√öltimaHora #Espa√±a ‚Ä¶" autocomplete="off" />
            </label>
          </div>

          <label class="field">
            <span class="field__label">Titular</span>
            <input id="headline" class="input" type="text" placeholder="Se rellena al elegir noticia‚Ä¶" autocomplete="off" />
          </label>

          <label class="field">
            <span class="field__label">URL de la fuente</span>
            <input id="sourceUrl" class="input" type="url" placeholder="https://‚Ä¶" inputmode="url" />
          </label>

          <div class="row row--wrap">
            <label class="chip">
              <input id="optIncludeLive" type="checkbox" checked />
              <span>Incluir #ENVIVO</span>
            </label>
            <label class="chip">
              <input id="optIncludeSource" type="checkbox" checked />
              <span>Incluir Fuente</span>
            </label>
          </div>

          <label class="field">
            <span class="field__label">Template</span>
            <textarea id="template" class="input input--area mono" rows="8" spellcheck="false"></textarea>
          </label>

          <div class="row row--wrap">
            <button id="btnTrim" class="btn btn--sm" type="button">Recortar titular</button>
            <button id="btnGenTags" class="btn btn--sm" type="button">Generar hashtags</button>
            <button id="btnCopyUrl" class="btn btn--sm" type="button">Copiar URL</button>

            <div class="spacer"></div>

            <button id="btnCopy" class="btn btn--primary btn--sm" type="button">Copiar tweet</button>
            <button id="btnX" class="btn btn--x btn--sm" type="button">Abrir en X</button>
            <button id="btnResetTemplate" class="btn btn--sm" type="button">Reset template</button>
          </div>

          <div class="warn" id="warn" aria-live="polite"></div>

          <div class="previewWrap">
            <div class="previewTitle">
              Preview (texto)
              <span class="mini muted" id="charCount"></span>
            </div>

            <pre id="preview" class="preview"></pre>

            <!-- Vista previa estilo X -->
            <div class="xMock" aria-label="Vista previa estilo X">
              <div class="xMock__avatar" aria-hidden="true"></div>
              <div class="xMock__body">
                <div class="xMock__nameRow">
                  <div class="xMock__name">GlobalEyeTV</div>
                  <div class="xMock__handle">@globaleyetv</div>
                </div>

                <div id="xMockText" class="xMock__text"></div>

                <a id="xMockCard" class="xMock__card hidden" href="#" target="_blank" rel="noopener noreferrer" aria-hidden="true">
                  <div id="xMockCardImg" class="xMock__cardImg"></div>
                  <div class="xMock__cardMeta">
                    <div id="xMockCardTitle" class="xMock__cardTitle"></div>
                    <div id="xMockCardUrl" class="xMock__cardUrl"></div>
                  </div>
                </a>
              </div>
            </div>
          </div>

          <hr class="hr" />

          <div class="panel__title panel__title--sm">Opciones</div>

          <div class="options">
            <label class="field field--inline">
              <span class="field__label">Ventana</span>
              <select id="timeFilter" class="input input--sm">
                <option value="10">10 min</option>
                <option value="30">30 min</option>
                <option value="60" selected>60 min</option>
                <option value="180">3 h</option>
                <option value="360">6 h</option>
                <option value="1440">24 h</option>
              </select>
            </label>

            <label class="field field--inline">
              <span class="field__label">Delay</span>
              <input id="delayMin" class="input input--sm" type="number" min="0" max="60" value="0" />
            </label>

            <label class="field field--inline">
              <span class="field__label">Orden</span>
              <select id="sortBy" class="input input--sm">
                <option value="impact" selected>Impacto</option>
                <option value="recent">Recientes</option>
              </select>
            </label>

            <label class="field field--inline" title="Velocidad del ticker en p√≠xeles por segundo (menos = m√°s lento)">
              <span class="field__label">Ticker</span>
              <input id="tickerSpeed" class="input input--sm" type="number" min="10" max="220" value="28" />
              <span id="tickerSpeedVal" class="mini muted" style="margin-left:8px;">28 pps</span>
            </label>

            <label class="field field--inline">
              <span class="field__label">Auto</span>
              <input id="optAutoRefresh" type="checkbox" checked />
            </label>

            <label class="field field--inline">
              <span class="field__label">Cada</span>
              <input id="refreshSec" class="input input--sm" type="number" min="20" max="600" value="60" />
            </label>

            <label class="field field--inline">
              <span class="field__label">Resolver</span>
              <input id="optResolveLinks" type="checkbox" checked />
            </label>

            <label class="field field--inline">
              <span class="field__label">URL original</span>
              <input id="optShowOriginal" type="checkbox" checked />
            </label>

            <label class="field field--inline">
              <span class="field__label">Ocultar usados</span>
              <input id="optHideUsed" type="checkbox" checked />
            </label>

            <label class="field field--inline">
              <span class="field__label">Solo ‚ÄúLISTO‚Äù</span>
              <input id="optOnlyReady" type="checkbox" />
            </label>

            <label class="field field--inline">
              <span class="field__label">ES prioridad</span>
              <input id="optOnlySpanish" type="checkbox" checked />
            </label>

            <label class="field field--inline">
              <span class="field__label">Cat</span>
              <select id="catFilter" class="input input--sm">
                <option value="all" selected>Todo</option>
                <option value="spain">Espa√±a</option>
                <option value="world">Mundo</option>
                <option value="economy">Econom√≠a</option>
                <option value="tech">Tech</option>
                <option value="crime">Sucesos</option>
                <option value="health">Salud</option>
                <option value="sports">Deportes</option>
                <option value="ent">Cultura/TV</option>
              </select>
            </label>

            <label class="field field--inline">
              <span class="field__label">Mostrar</span>
              <input id="showLimit" class="input input--sm" type="number" min="10" max="500" value="120" />
            </label>

            <label class="field field--inline">
              <span class="field__label">Cap</span>
              <input id="fetchCap" class="input input--sm" type="number" min="80" max="2000" value="240" />
            </label>

            <label class="field field--inline">
              <span class="field__label">Batch</span>
              <input id="batchFeeds" class="input input--sm" type="number" min="4" max="50" value="12" />
            </label>
          </div>

          <div class="mini muted">
            Tip: Shift+click en ‚ÄúRefrescar‚Äù = force + reset backoff. ¬∑ Ticker: menos pps = m√°s lento.
          </div>
        </div>
      </section>

      <!-- RIGHT: NEWS -->
      <section class="panel" aria-label="Lista de noticias">
        <div class="panel__head">
          <div>
            <div class="panel__title">Noticias</div>
            <div class="panel__sub">Click en una noticia para rellenar el tweet.</div>
          </div>
        </div>

        <div class="panel__body panel__body--flush">
          <div id="newsList" class="newsList" aria-label="Lista de noticias"></div>
        </div>
      </section>
    </div>
  </main>

  <!-- MODAL FEEDS -->
  <div
    id="modal"
    class="modal hidden"
    aria-hidden="true"
    aria-modal="true"
    role="dialog"
    aria-label="Gesti√≥n de feeds"
  >
    <div class="modal__panel">
      <div class="modal__head">
        <div>
          <div class="modal__title">Feeds</div>
          <div class="mini muted">Activa/desactiva, edita o importa/exporta JSON</div>
        </div>
        <button id="btnCloseModal" class="btn btn--sm" type="button">Cerrar</button>
      </div>

      <div class="modal__body">
        <div class="row row--3">
          <input id="newFeedName" class="input input--sm" placeholder="Nombre" autocomplete="off" />
          <input id="newFeedUrl" class="input input--sm" placeholder="URL RSS/Atom" inputmode="url" />
          <button id="btnAddFeed" class="btn btn--primary btn--sm" type="button">A√±adir</button>
        </div>

        <div id="feedList" class="feedList"></div>

        <label class="field">
          <span class="field__label">Import / Export (JSON)</span>
          <textarea
            id="feedsJson"
            class="input input--area mono"
            rows="7"
            spellcheck="false"
            placeholder='[ { "name": "RTVE ‚Äî Mundo", "url": "https://‚Ä¶", "enabled": true, "cat":"world" } ]'
          ></textarea>
        </label>

        <div class="row row--4">
          <button id="btnExportFeeds" class="btn btn--sm" type="button">Export</button>
          <button id="btnImportFeeds" class="btn btn--sm" type="button">Import</button>
          <button id="btnRestoreDefaultFeeds" class="btn btn--sm" type="button">Defaults</button>
          <button id="btnSaveFeeds" class="btn btn--primary btn--sm" type="button">Guardar</button>
        </div>

        <div class="mini muted">
          Si alg√∫n feed falla por CORS, la app intenta proxy autom√°ticamente (CorsProxy / AllOrigins / CodeTabs / ThingProxy / Jina).
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL MEMBERSHIP (Planes FREE/PRO/ELITE) -->
  <div
    id="membModal"
    class="modal hidden"
    aria-hidden="true"
    aria-modal="true"
    role="dialog"
    aria-label="Planes de membres√≠a"
  >
    <div class="modal__panel">
      <div class="modal__head">
        <div>
          <div class="modal__title">Planes</div>
          <div class="mini muted">FREE ¬∑ PRO ¬∑ ELITE ‚Äî la app aplica l√≠mites y opciones seg√∫n tu plan.</div>
        </div>
        <button id="btnCloseMembModal" class="btn btn--sm" type="button">Cerrar</button>
      </div>

      <div class="modal__body">
        <div class="row row--wrap" style="margin-bottom:12px;">
          <span class="badge" id="membCurrentBadge">Plan actual: FREE</span>
          <span class="mini muted" id="membMsg"></span>
          <div class="spacer"></div>
          <button id="btnMembLogin" class="btn btn--sm" type="button">Entrar</button>
          <button id="btnMembManage" class="btn btn--sm" type="button" hidden>Gestionar</button>
        </div>

        <div id="tierCards" class="tierGrid" aria-label="Tarjetas de planes">
          <!-- app.js puede rellenar din√°micamente; estas cards son fallback visual -->
          <div class="tierCard" data-tier="free">
            <div class="tierCard__head">
              <div class="tierCard__name">FREE</div>
              <div class="tierCard__price">0‚Ç¨</div>
            </div>
            <ul class="tierCard__perks">
              <li>RSS + ticker b√°sico</li>
              <li>Resolver links (best-effort)</li>
              <li>Copiar plantilla + abrir en X</li>
            </ul>
            <div class="tierCard__cta">
              <button class="btn btn--sm" type="button" data-tier-choose="free">Usar FREE</button>
            </div>
          </div>

          <div class="tierCard" data-tier="pro">
            <div class="tierCard__head">
              <div class="tierCard__name">PRO</div>
              <div class="tierCard__price">4.99‚Ç¨/mes</div>
            </div>
            <ul class="tierCard__perks">
              <li>M√°s feeds + m√°s items</li>
              <li>Auto-refresh m√°s r√°pido</li>
              <li>M√°s im√°genes/OG + cach√©s</li>
            </ul>
            <div class="tierCard__cta">
              <button class="btn btn--primary btn--sm" type="button" data-tier-choose="pro">Mejorar a PRO</button>
            </div>
          </div>

          <div class="tierCard" data-tier="elite">
            <div class="tierCard__head">
              <div class="tierCard__name">ELITE</div>
              <div class="tierCard__price">9.99‚Ç¨/mes</div>
            </div>
            <ul class="tierCard__perks">
              <li>M√°ximo rendimiento (l√≠mite alto)</li>
              <li>Auto-refresh ultra</li>
              <li>M√°s extracci√≥n OG</li>
            </ul>
            <div class="tierCard__cta">
              <button class="btn btn--primary btn--sm" type="button" data-tier-choose="elite">Mejorar a ELITE</button>
            </div>
          </div>
        </div>

        <hr class="hr" />

        <div class="mini muted">
          Nota: en GitHub Pages, el plan ‚Äúreal‚Äù se confirma con backend (recomendado: Cloudflare Worker). En modo demo, puedes probar con:
          <span style="font-family: ui-monospace, monospace;">localStorage.setItem("tnp_membership_override","pro")</span>
        </div>
      </div>
    </div>
  </div>

  <noscript>
    <div class="noscript">Necesitas JavaScript para usar esta app.</div>
  </noscript>

  <!-- Banner de reparaci√≥n (aparece si la app no ‚Äúengancha‚Äù por cach√©/SW viejo) -->
  <div id="bootDiag" class="bootDiag hidden" aria-hidden="true">
    <div class="bootDiag__title">‚ö†Ô∏è La app no ha arrancado (probable cach√© / Service Worker)</div>
    <div class="bootDiag__msg">
      Si ves que ning√∫n bot√≥n responde o no se refresca nada, suele ser porque el navegador est√° sirviendo un <b>app.js viejo</b> desde cach√©.
      Pulsa <b>Reparar</b> para limpiar caches + desregistrar SW y recargar.
    </div>
    <div class="bootDiag__row">
      <button id="btnRepair" class="btn btn--primary btn--sm" type="button">Reparar (limpiar cach√© + SW)</button>
      <button id="btnForceSwUpdate" class="btn btn--sm" type="button">Forzar update SW</button>
      <button id="btnHideDiag" class="btn btn--sm" type="button">Ocultar</button>
    </div>
  </div>

  <!-- BOOTSTRAP: auto-update SW + diagn√≥stico + ‚Äúreparar‚Äù aunque app.js est√© roto -->
  <script>
    (function () {
      "use strict";

      function q(sel){ try { return document.querySelector(sel); } catch { return null; } }
      var buildMeta = q('meta[name="tnp-build"]');
      var BUILD_TAG = (buildMeta && buildMeta.content) ? String(buildMeta.content) : "tnp-v4.2.0_dev";

      // Cache-bust en SW (nuevo URL => browser re-eval√∫a SW)
      var SW_URL = "./sw.js?v=" + encodeURIComponent(BUILD_TAG);

      var bootDiag = document.getElementById("bootDiag");
      var statusEl = document.getElementById("status");
      var repairBtn = document.getElementById("btnRepair");
      var forceBtn = document.getElementById("btnForceSwUpdate");
      var hideBtn = document.getElementById("btnHideDiag");

      function setStatusSafe(msg) {
        try { if (statusEl) statusEl.textContent = msg; } catch {}
      }
      function showDiag() {
        try {
          if (!bootDiag) return;
          bootDiag.classList.remove("hidden");
          bootDiag.setAttribute("aria-hidden", "false");
        } catch {}
      }
      function hideDiag() {
        try {
          if (!bootDiag) return;
          bootDiag.classList.add("hidden");
          bootDiag.setAttribute("aria-hidden", "true");
        } catch {}
      }

      // Captura errores tempranos
      window.addEventListener("error", function (e) {
        try {
          var m = (e && (e.message || (e.error && e.error.message)))
            ? (e.message || e.error.message)
            : "Error JS";
          setStatusSafe("‚ùå " + m);
        } catch {}
      });

      var swReg = null;
      var swReloading = false;

      async function registerAndUpdateSW() {
        if (!("serviceWorker" in navigator)) return;

        try {
          swReg = await navigator.serviceWorker.register(SW_URL, { updateViaCache: "none" });
        } catch (e) {
          // Si falla SW, la app sigue funcionando sin PWA
          return;
        }

        try { await swReg.update(); } catch {}

        function trySkipWaiting(reg) {
          try {
            if (!reg) return;
            var w = reg.waiting;
            if (w) w.postMessage({ type: "SKIP_WAITING" });
          } catch {}
        }

        swReg.addEventListener("updatefound", function () {
          try {
            var nw = swReg.installing;
            if (!nw) return;

            nw.addEventListener("statechange", function () {
              if (nw.state === "installed" && navigator.serviceWorker.controller) {
                trySkipWaiting(swReg);
              }
            });
          } catch {}
        });

        navigator.serviceWorker.addEventListener("controllerchange", function () {
          if (swReloading) return;
          swReloading = true;
          location.reload();
        });

        // Auto update (GH Pages)
        setInterval(function () {
          try { if (swReg) swReg.update(); } catch {}
        }, 60 * 1000);
      }

      registerAndUpdateSW();

      function appSeemsBooted() {
        var s = (statusEl && statusEl.textContent) ? String(statusEl.textContent).trim() : "";
        if (s.indexOf("TNP listo") !== -1) return true;
        return false;
      }

      // Diag: espera m√°s para no molestar en redes lentas.
      window.addEventListener("load", function () {
        setTimeout(function () {
          try {
            if (!appSeemsBooted()) showDiag();
          } catch {}
        }, 6500);
      });

      // Si la app termina arrancando, oculta el diag autom√°ticamente
      setInterval(function () {
        try { if (appSeemsBooted()) hideDiag(); } catch {}
      }, 800);

      async function purgeAllTnpCachesAndSw() {
        // Unregister SWs
        try {
          if ("serviceWorker" in navigator) {
            var regs = await navigator.serviceWorker.getRegistrations();
            await Promise.all(regs.map(function (r) { try { return r.unregister(); } catch { return null; } }));
          }
        } catch {}

        // Delete SOLO caches tnp-*
        try {
          if ("caches" in window) {
            var keys = await caches.keys();
            await Promise.all(keys.map(function (k) {
              if (String(k).indexOf("tnp-") === 0) return caches.delete(k);
              return Promise.resolve(false);
            }));
          }
        } catch {}
      }

      function hardReloadWithBuster() {
        try {
          var u = new URL(location.href);
          u.searchParams.set("__repair", String(Date.now()));
          location.replace(u.toString());
        } catch {
          location.reload();
        }
      }

      if (repairBtn) {
        repairBtn.addEventListener("click", async function () {
          setStatusSafe("Reparando‚Ä¶ (limpiando cach√©s/SW)");
          await purgeAllTnpCachesAndSw();
          hardReloadWithBuster();
        });
      }

      if (forceBtn) {
        forceBtn.addEventListener("click", async function () {
          setStatusSafe("Forzando update SW‚Ä¶");
          try {
            if (swReg) {
              await swReg.update();
              try { if (swReg.waiting) swReg.waiting.postMessage({ type: "SKIP_WAITING" }); } catch {}
            } else {
              await registerAndUpdateSW();
            }
            setStatusSafe("Update SW solicitado.");
          } catch {
            setStatusSafe("Update SW fall√≥.");
          }
        });
      }

      if (hideBtn) {
        hideBtn.addEventListener("click", function () {
          hideDiag();
        });
      }
    })();
  </script>

  <!-- Config boot (ANTES de app.js) -->
  <script defer src="./config/boot-config.js?v=tnp-v4.2.0_2026-01-12d"></script>

  <!-- app.js v4.2.0 ‚Äî cache-bust controlado -->
  <script defer src="./app.js?v=tnp-v4.2.0_2026-01-12d"></script>
</body>
</html>
